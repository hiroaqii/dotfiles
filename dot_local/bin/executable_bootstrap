#!/usr/bin/env bash
# -----------------------------------------------------------------------------
# bootstrap
#
# Purpose:
#   Minimal, idempotent bootstrap script for dotfiles on:
#     - macOS
#     - Arch Linux
#
# What it does:
#   - Installs mise     (runtime/tool version manager) if missing
#   - Installs chezmoi  (dotfile manager) if missing
#   - Installs antidote (zsh plugin manager) if missing
#
# What it does NOT do:
#   - Upgrade mise / chezmoi / antidote (manual by design)
#   - Install Homebrew
#   - Modify shell configuration files
#
# Notes:
#   - Safe to run multiple times
#   - Requires network access (curl / git)
#
# git clone & execute:
#  $ git clone git@github.com:hiroaqii/dotfiles.git ~/.local/share/chezmoi
#  $ cd ~/.local/share/chezmoi/dot_local/bin/
#  $ sh executable_bootstrap
#
# -----------------------------------------------------------------------------

set -Eeuo pipefail

# ---- logging helpers ---------------------------------------------------------
log() { printf '%s\n' "INFO: $*"; }
warn() { printf '%s\n' "WARN: $*" >&2; }
die() {
  printf '%s\n' "ERROR: $*" >&2
  exit 1
}

have() { command -v "$1" >/dev/null 2>&1; }

# ---- platform detection ------------------------------------------------------
OS=""
case "$(uname -s)" in
Darwin) OS="macos" ;;
Linux) OS="linux" ;;
*) die "Unsupported OS: $(uname -s)" ;;
esac

is_arch() {
  [[ "$OS" == "linux" ]] && [[ -f /etc/arch-release ]]
}

# ---- prerequisites -----------------------------------------------------------
ensure_prereqs() {
  if ! have curl; then
    die "curl is required but not found. Please install curl first."
  fi

  if ! have git; then
    if is_arch && have pacman; then
      log "git not found; installing via pacman..."
      sudo pacman -Sy --needed --noconfirm git
    else
      die "git is required but not found. Please install git first."
    fi
  fi
}

# ---- mise install ------------------------------------------------------------
install_mise() {
  if have mise; then
    log "mise already installed: $(command -v mise)"
    return 0
  fi

  log "Installing mise..."
  curl -fsSL https://mise.jdx.dev/install.sh | sh

  if [[ -x "${HOME}/.local/bin/mise" ]]; then
    export PATH="${HOME}/.local/bin:${PATH}"
  fi

  if have mise; then
    log "mise installed: $(mise --version 2>/dev/null || echo installed)"
  else
    warn "mise installed but not on PATH yet; open a new shell."
  fi

  log "Note: mise upgrade is manual (mise self-update)."
}

# ---- chezmoi install ---------------------------------------------------------
install_chezmoi() {
  if have chezmoi; then
    log "chezmoi already installed: $(command -v chezmoi)"
    return 0
  fi

  log "Installing chezmoi..."

  # Official installer (binary install, no package manager required)
  sh -c "$(curl -fsLS get.chezmoi.io)" -- -b "${HOME}/.local/bin"

  if [[ -x "${HOME}/.local/bin/chezmoi" ]]; then
    export PATH="${HOME}/.local/bin:${PATH}"
  fi

  if have chezmoi; then
    log "chezmoi installed: $(chezmoi --version | head -n1)"
  else
    warn "chezmoi installed but not on PATH yet; open a new shell."
  fi

  log "Note: chezmoi upgrade is manual (chezmoi upgrade)."
}

# ---- antidote install --------------------------------------------------------
install_antidote() {
  local target_dir="${XDG_DATA_HOME:-$HOME/.local/share}/antidote"
  local repo_url="https://github.com/mattmc3/antidote.git"

  if [[ -d "${target_dir}/.git" ]]; then
    log "antidote already installed at: ${target_dir}"
    log "Note: antidote update is manual."
    return 0
  fi

  log "Installing antidote to: ${target_dir}"
  mkdir -p "$(dirname "${target_dir}")"
  git clone --depth=1 "${repo_url}" "${target_dir}"

  log "antidote installed."
}

# ---- main -------------------------------------------------------------------
main() {
  log "Starting bootstrap (OS=${OS}, arch=$(is_arch && echo yes || echo no))"

  ensure_prereqs
  install_mise
  install_chezmoi
  install_antidote

  log "Bootstrap complete."
  log "Recommended next steps:"
  log "  *Prerequisite*: Set the default shell to zsh."
  log "  - Open a new terminal"
  log "  - Edit:"
  log "      mkdir ~/.config/chezmoi"
  log "      vi ~/.config/chezmoi/chezmoi.toml"
  log "      ↓↓↓"
  log "      [data]"
  log "         type = \"xxxx\""
  log "  - Run:"
  log "      ~/.local/bin/chezmoi diff"
  log "      ~/.local/bin/chezmoi apply"
  log "      mise upgrade"
  log "  - Manual upgrades:"
  log "      mise self-update"
  log "      chezmoi upgrade"
}

main "$@"
